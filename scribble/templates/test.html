<!DOCTYPE html>
<html>

<head>
    <title>Scribble Test Suite</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <script type="text/javascript" src="{{ STATIC_URL }}js/lib/jquery.js"></script>
    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/qunit.css" />
    <script type="text/javascript" src="{{ STATIC_URL }}js/lib/qunit.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/lib/underscore.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/lib/knockout.js"></script>
    <script
        type="text/javascript" charset="utf-8" src="{{ STATIC_URL }}js/lib/require.js"
        data-main="{{ STATIC_URL }}js/{% block requirejs_main %}main{% endblock %}"
    ></script>
</head>

<body>
    <h1  id="qunit-header">Scribble Test Suite</h1>
    <h2  id="qunit-banner"></h2>
    <div id="qunit-testrunner-toolbar"></div>
    <h2  id="qunit-userAgent"></h2>
    <ol  id="qunit-tests"></ol>
    <div id="qunit-fixture"></div>

    <script>
        module('main');
        
        var loaded_event_fired = false;
        $(document).on('scribble_loaded', function() { loaded_event_fired = true; });
        
        test('Loading Scribble', function() {
            expect(2);
            ok(scribble, 'Scribble present');
            ok(loaded_event_fired, 'Loaded event fired');
        });


        module('scribble');
        
        test('Scribble object public props', function() {
            expect(7);
            equal(typeof(scribble.User    ), 'function', 'scribble.User present'    );
            equal(typeof(scribble.Author  ), 'function', 'scribble.Author present'  );
            equal(typeof(scribble.Source  ), 'function', 'scribble.Source present'  );
            equal(typeof(scribble.Category), 'function', 'scribble.Category present');
            equal(typeof(scribble.Article ), 'function', 'scribble.Article present' );
            equal(typeof(scribble.Listing ), 'function', 'scribble.Listing present' );
            equal(typeof(scribble.Site    ), 'function', 'scribble.Site present'    );
        });
        
        test('Scribble object private props', function() {
            expect(3);
            equal(typeof(scribble._EllaObject), 'function', 'scribble._EllaObject present');
            equal(typeof(scribble._Fields    ), 'object',   'scribble._Fields present'    );
            equal(typeof(scribble._Drawable  ), 'function', 'scribble._Drawable present'  );
        });


        module('EllaObject');
        var user;
        
        test('EllaObject props', function() {
            user = new scribble.User({ username: 'johndoe' });
            expect(4);
            ok(user instanceof scribble.User, 'inherited from constructor');
            strictEqual(user.constructor, scribble.User, 'constructor matches');
            equal(typeof(user.drawable), 'object', 'ellaObject isa Drawable');
            deepEqual(_.keys(user.fields), ['username'], 'fields are as declared');
        });
        
        test('EllaObject methods', function() {
            expect(7);
            deepEqual(user.values(), {username:'johndoe'}, 'values()');
            deepEqual(user.fields_array(), [ $.extend({}, user.fields.username, {name: 'username'}) ], 'fields_array()');
            strictEqual(user.get('id'), undefined, 'get unset field');
            strictEqual(user.set('id', 1), null, 'set() new field');
            strictEqual(user.set('id', 2), 1, 'set() returns previous value');
            strictEqual(user.get('id'), 2, 'get() set field');
            strictEqual(user.get_observable('username')(), user.get('username'), 'get_observable()');
        });
        
        test('EllaObject exceptions', function() {
            expect(2);
            raises(function() { user.set('foo', 2) }, 'set() undeclared field');
            raises(function() { user.get('foo')    }, 'get() undeclared field');
        });
        
        test('EllaObject backend', function() {
            expect(11);
            stop(6);
            var testuser = new scribble.User({ username: '_test_user' });
            
            function assert_test_object_absence() {
                var promise = new $.Deferred();
                testuser.fetch()
                .done( function(users) {
                    if (users.length == 0) {
                        promise.resolve();
                    }
                    else {
                        promise.reject();
                    }
                });
                return promise;
            }
            assert_test_object_absence()
            .fail(function() {
                start(6);
                throw 'Test user (username: _test_user) already present -- bailing out';
            })
            .done(save_test_object);
            
            function save_test_object() {
                var testuser = new scribble.User({ username: '_test_user' });
                var testuser2 = new scribble.User({ username: '_test_user2' });
                testuser2.save();
                testuser.save()
                .done(function() {
                    ok(true, 'test object saved');
                })
                .fail(function() {
                    ok(false, 'test object saved');
                })
                .then(function() {
                    start();
                    fetch_test_object();
                });
            }
            
            function fetch_test_object() {
                testuser.fetch()
                .done(function(data) {
                    ok(true, 'fetch succeeded');
                    equal(data.length, 1, 'fetch got 1 object');
                    var u = data[0];
                    equal(u.get('username'), '_test_user', 'fetched object has unchanged username');
                    ok(u.get('id'), 'fetched object has an id');
                })
                .fail(function() {
                    ok(false, 'fetch succeeded');
                    ok(false, 'fetch got 1 object');
                    ok(false, 'fetched object has unchanged username');
                    ok(false, 'fetched object has an id');
                })
                .then(function() {
                    start();
                    load_test_object();
                });
            }
            
            function load_test_object() {
                testuser.load()
                .done(function() {
                    ok(true, 'load succeeded');
                    ok(testuser.get('id'), 'loaded object has id');
                    equal(testuser.get('username'), '_test_user', 'loaded object has unchanged username');
                })
                .fail(function() {
                    ok(false, 'load succeeded');
                    ok(false, 'loaded object has id');
                    ok(false, 'loaded object has unchanged username');
                })
                .then(function() {
                    start();
                    delete_test_object();
                });
            }
            
            function delete_test_object() {
                testuser.delete()
                .done(function() {
                    ok('true', 'deletion succeeded');
                })
                .fail(function() {
                    ok('false', 'deletion succeeded');
                })
                .then(function() {
                    start();
                    check_test_object_disappeared();
                });
            }
            
            function check_test_object_disappeared() {
                new scribble.User({username: '_test_user'}).fetch()
                .done(function(data) {
                    equal(data.length, 0, 'deleted object disappeared from DB');
                })
                .fail(function() {
                    throw 'Failed fetching deleted object';
                })
                .then(function() {
                    start();
                    check_test_object2_survived();

                });
            }
            
            function check_test_object2_survived() {
                var testuser2 = new scribble.User({username: '_test_user2'});
                testuser2.fetch()
                .done(function(data) {
                    equal(data.length, 1, 'test object2 survived');
                })
                .fail(function() {
                    throw 'Failed fetching test object2';
                })
                .then(function() {
                    start();
                    testuser2.delete();
                });
            }
        });
        
        test('EllaObject non-instance methods', function() {
            expect(1);
            var Fields = scribble._Fields;
            scribble.User.declare_field('foo', new Fields.text());
            var testuser = new scribble.User({foo: 'bar'});
            equal(testuser.get('foo'), 'bar', 'declared field present');
        });
        
    </script>
</body>

</html>
